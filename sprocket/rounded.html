<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sprocket Generator</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #drawing {
      border: 1px solid #ccc;
      width: 100%;
      max-width: 400px;
      height: auto;
      aspect-ratio: 1/1;
    }
    .controls {
      margin-bottom: 1em;
    }
    .controls label {
      display: block;
      margin-top: 0.5em;
    }
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      background: #ddd;
      border-radius: 5px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #444;
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #444;
      cursor: pointer;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 0.5em;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

<div class="controls">
  <label for="teethSlider">
    Teeth: <span id="teethValue">15</span>
  </label>
  <input type="range" id="teethSlider" min="9" max="45" value="15">

  <label for="toothLengthSlider">
    Tooth Length: <span id="toothLengthValue">2.0</span>
  </label>
  <input type="range" id="toothLengthSlider" min="0" max="4" step="0.1" value="2">

  <label for="circleSlider">
    Center Circle Radius: <span id="circleValue">2.0</span>
  </label>
  <input type="range" id="circleSlider" min="2" max="20" step="0.1" value="2">

  <label for="roundoffSlider">
    Tooth Roundoff: <span id="roundoffValue">0</span>
  </label>
  <input type="range" id="roundoffSlider" min="-1" max="5" step="1" value="0">

  <div class="row">
    <input type="color" id="colorPicker" value="#ff0000">
    <button id="downloadSvgBtn">Download SVG</button>
  </div>
</div>

<svg id="drawing" viewBox="-100 -100 200 200"></svg>

<script type="module">
  import { D2 } from "./D2.js";

  function originToVertex(n, l = 12.7) {
    return l / (2 * Math.sin(Math.PI / n));
  }

  const svg = document.getElementById("drawing");
  const teethSlider = document.getElementById("teethSlider");
  const teethValue = document.getElementById("teethValue");
  const toothLengthSlider = document.getElementById("toothLengthSlider");
  const toothLengthValue = document.getElementById("toothLengthValue");
  const circleSlider = document.getElementById("circleSlider");
  const circleValue = document.getElementById("circleValue");
  const colorPicker = document.getElementById("colorPicker");
  const downloadSvgBtn = document.getElementById("downloadSvgBtn");
  const roundoffSlider = document.getElementById("roundoffSlider");
  const roundoffValue = document.getElementById("roundoffValue");

  let currentTeeth = parseInt(teethSlider.value, 10);
  let currentToothLength = parseFloat(toothLengthSlider.value);
  let currentCircleRadius = parseFloat(circleSlider.value);
  let currentColor = colorPicker.value;
  let currentRoundoff = parseInt(roundoffSlider.value, 10);

  // UI (-1..5) â†’ internal (1..-5)
  function mapRoundoff(uiVal) {
    return -uiVal;
  }

  function updateCircleSliderRange(teeth) {
    const rivitRadius = originToVertex(teeth);
    const maxVal = Math.max(2, rivitRadius - 8);
    circleSlider.max = maxVal.toFixed(1);
    if (parseFloat(circleSlider.value) > maxVal) {
      circleSlider.value = maxVal.toFixed(1);
    }
    currentCircleRadius = parseFloat(circleSlider.value);
    circleValue.textContent = currentCircleRadius.toFixed(1);
  }

  function drawSprocket(teeth, toothLength, fillColor, circleRadius, roundoffUI) {
    svg.innerHTML = ""; 
    currentTeeth = teeth;
    currentToothLength = toothLength;
    currentColor = fillColor;
    currentCircleRadius = circleRadius;
    currentRoundoff = roundoffUI;

    const roundoff = mapRoundoff(roundoffUI);

    const rivitRadius = originToVertex(teeth);
    const toothRadian = 360 / teeth;
    const toothAngle = 22;

    const origin = new D2(0, 0);
    const pConstruct = origin.polar(0, rivitRadius);
    const p1 = pConstruct.polar(-90 - toothAngle, 3.97);
    const p0 = p1.polar(-toothAngle, toothLength);
    const p2 = p1.mirrorY();
    const p3 = p0.mirrorY();
    const pminus = p0.rotate(origin, 360/teeth);

    const pmid = p3.midpoint(pminus);
    const pmidAngle = pmid.angleTo(origin);
    const pmidControl = pmid.polar(pmidAngle, roundoff);

    let pathString = `M ${p0.x.toFixed(2)} ${p0.y.toFixed(2)} 
                      L ${p1.x.toFixed(2)} ${p1.y.toFixed(2)} 
                      A 3.97 3.97 0 0 0 ${p2.x.toFixed(2)} ${p2.y.toFixed(2)} 
                      L ${p3.x.toFixed(2)} ${p3.y.toFixed(2)} 
                      Q ${pmidControl.x.toFixed(2)} ${pmidControl.y.toFixed(2)} ${pminus.x.toFixed(2)} ${pminus.y.toFixed(2)} `;

    for (let t = 0; t < teeth - 2; t++) {
      let a = toothRadian * (t + 1);
      let p1p = p1.rotate(origin, a);-5
      let p0p = p0.rotate(origin, a);
      let p2p = p2.rotate(origin, a);
      let p3p = p3.rotate(origin, a);
      let pminusp = pminus.rotate(origin, a);

      let pmidp = p3p.midpoint(pminusp);
      let pmidAnglep = pmidp.angleTo(origin);
      let pmidControlp = pmidp.polar(pmidAnglep, roundoff);

      pathString += `L ${p0p.x.toFixed(2)} ${p0p.y.toFixed(2)} 
                     L ${p1p.x.toFixed(2)} ${p1p.y.toFixed(2)} 
                     A 3.97 3.97 0 0 0 ${p2p.x.toFixed(2)} ${p2p.y.toFixed(2)} 
                     L ${p3p.x.toFixed(2)} ${p3p.y.toFixed(2)} 
                     Q ${pmidControlp.x.toFixed(2)} ${pmidControlp.y.toFixed(2)} ${pminusp.x.toFixed(2)} ${pminusp.y.toFixed(2)} `;
    }

    let a = toothRadian * (teeth - 1);
    let p1p = p1.rotate(origin, a);
    let p0p = p0.rotate(origin, a);
    let p2p = p2.rotate(origin, a);
    let p3p = p3.rotate(origin, a);
    let pminusp = pminus.rotate(origin, a);

    let pmidp = p3p.midpoint(pminusp);
    let pmidAnglep = pmidp.angleTo(origin);
    let pmidControlp = pmidp.polar(pmidAnglep, roundoff);

    pathString += `L ${p0p.x.toFixed(2)} ${p0p.y.toFixed(2)} 
                   L ${p1p.x.toFixed(2)} ${p1p.y.toFixed(2)} 
                   A 3.97 3.97 0 0 0 ${p2p.x.toFixed(2)} ${p2p.y.toFixed(2)} 
                   L ${p3p.x.toFixed(2)} ${p3p.y.toFixed(2)} 
                   Q ${pmidControlp.x.toFixed(2)} ${pmidControlp.y.toFixed(2)} ${pminusp.x.toFixed(2)} ${pminusp.y.toFixed(2)} Z`;

    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", pathString);
    path.setAttribute("stroke", "none");
    path.setAttribute("fill", fillColor);
    svg.appendChild(path);

    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", origin.x);
    circle.setAttribute("cy", origin.y);
    circle.setAttribute("r", circleRadius);
    circle.setAttribute("fill", "#fff");
    circle.setAttribute("stroke", "none");
    svg.appendChild(circle);
  }

  // initial setup
  updateCircleSliderRange(currentTeeth);
  drawSprocket(currentTeeth, currentToothLength, currentColor, currentCircleRadius, currentRoundoff);

  // handlers
  teethSlider.addEventListener("input", (e) => {
    const val = parseInt(e.target.value, 10);
    teethValue.textContent = val;
    updateCircleSliderRange(val);
    drawSprocket(val, currentToothLength, currentColor, currentCircleRadius, currentRoundoff);
  });

  toothLengthSlider.addEventListener("input", (e) => {
    const val = parseFloat(e.target.value);
    toothLengthValue.textContent = val.toFixed(1);
    drawSprocket(currentTeeth, val, currentColor, currentCircleRadius, currentRoundoff);
  });

  circleSlider.addEventListener("input", (e) => {
    const val = parseFloat(e.target.value);
    circleValue.textContent = val.toFixed(1);
    drawSprocket(currentTeeth, currentToothLength, currentColor, val, currentRoundoff);
  });

  colorPicker.addEventListener("input", (e) => {
    drawSprocket(currentTeeth, currentToothLength, e.target.value, currentCircleRadius, currentRoundoff);
  });

  roundoffSlider.addEventListener("input", (e) => {
    const val = parseInt(e.target.value, 10);
    roundoffValue.textContent = val;
    drawSprocket(currentTeeth, currentToothLength, currentColor, currentCircleRadius, val);
  });

  // download SVG
  downloadSvgBtn.addEventListener("click", () => {
    const svgData = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="-100 -100 200 200">${svg.innerHTML}</svg>`;
    const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;

    const toothLenStr = currentToothLength.toFixed(1).replace('.', '-');
    link.download = `sprocket_${currentTeeth}_${toothLenStr}_roundoff${currentRoundoff}.svg`;

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  });
</script>

</body>
</html>
